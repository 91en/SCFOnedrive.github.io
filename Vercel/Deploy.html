
<html lang="en-us">
    <head>
        <title>Deploy OneManager to Vercel</title>
        <meta name=viewport content="width=device-width,initial-scale=1">
        <script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
    </head>
    <body>
        <h1>Deploy to Vercel with zip file</h1>
        (Click <a href="DeployFolder.html">here</a> to Deploy with folder.)
        <h4>1. Download zip file from <a href="https://github.com/qkqpttgf/OneManager-php/archive/refs/heads/master.zip" target="_blank">https://github.com/qkqpttgf/OneManager-php</a></h4>
        <h4>2. Choose the zip file:</h4>
            <input id="upload_file" type="file" name="upload_filename">
        <h4>3. <a href="https://vercel.com/account/tokens" target="_blank">Click here to Creat a token</a>, and input:</h4>
            <label>Token: <input id="VercelToken" name="VercelToken" type="password" placeholder="" value=""></label>
        <h4>4. Input a name for your project: </h4>
            <label>Name: <input id="projectname" name="projectname" type="text" placeholder="lower case alphanumeric characters and hyphens" size="" value="onemanager"></label>
            <br>
            You can overlay an existed project.<br>
            (You will lost your config, please export the config before overlay.)
        <h4>5. Click the "Deploy" button</h4>
            <input id="upload_submit" onclick="preup();" value="Deploy" type="button">
        <div id="showerror"></div>
        <script type="text/javascript">
            var errordiv = document.getElementById("showerror");
            function preup() {
                var VercelToken = document.getElementById("VercelToken").value;
                var projectname = document.getElementById("projectname").value;
                if (VercelToken=="") {
                    document.getElementById("VercelToken").parentNode.style.color = "red";
                    alert("Input VercelToken");
                    return;
                }
                if (projectname=="") {
                    document.getElementById("projectname").parentNode.style.color = "red";
                    alert("Input projectname");
                    return;
                }

                errordiv.innerHTML = "Finding path of files in zip.";
                var zipfile = document.getElementById('upload_file').files[0];
                var haveIndex = 0;
                var dirpath = "";
                var num = 0;
                var p = 0;
                var new_zip = new JSZip();
                new_zip.loadAsync(zipfile)
                .catch(function(e){
                    //console.log(e);
                    errordiv.innerHTML += "<br>" + e;
                    clearInterval(findPath);
                })
                .then(function(zip) {
                    let files = zip.files;
                    //console.log(files);
                    for (filename in files) {
                        //console.log(filename);
                        if (filename.substr(-9)==="index.php") {
                            haveIndex++;
                            dirpath = filename.substr(0, filename.length-9);
                        }
                        if (zip.file(filename)!==null) num++;
                    }
                    p = 1;
                });

                var findPath = setInterval(function(){
                    if (p===0) {
                        console.log(num);
                    } else {
                        clearInterval(findPath);
                        //console.log(num);
                        if (haveIndex!==1) {
                            errordiv.innerHTML += "<br>Error: not find index.php or more then one.";
                            //alert("No index.php or more then 1");
                            return;
                        }
                        console.log("find path End.");
                        errordiv.innerHTML += " ---- done.<br>Path is \"" + dirpath + "\" .";
                        checkDeploys(projectname, VercelToken).then(a => {
                            console.log("no building " + a);
                            getFileContent(dirpath, num);
                        }, a => {
                            console.log("is building " + a);
                        });
                    }
                }, 1000);

                return;
            }

            function checkDeploys(name, VercelToken) {
                errordiv.innerHTML += "<br>Check if deploying.";
                return new Promise(function(resolve, reject){
                var r = 0;
                var xhr = new XMLHttpRequest();
                var url = "https://api.vercel.com/v6/deployments/?app=" + name;
                xhr.open("GET", url);
                xhr.setRequestHeader("Authorization", "Bearer " + VercelToken);
                
                xhr.onload = function(e) {
                    //console.log(JSON.parse(xhr.responseText));
                    if (xhr.status==200) {
                        var deploys = JSON.parse(xhr.responseText).deployments;
                        deploys.forEach(element => {
                            //console.log(element.state);
                            if (element.state!=="READY") r++;
                        });
                        if (r===0) {
                            errordiv.innerHTML += " ---- done.";
                            resolve();
                        } else {
                            errordiv.innerHTML += "<br>There is a deployment building, please wait.";
                            reject();
                            // if continue deploy, please wait the last one done.
                            //return setTimeout(function() { resolve(checkDeploys(name, VercelToken)) }, 1000);
                        }
                    } else {
                        console.log(xhr.status);
                        console.log(xhr.responseText);
                        errordiv.innerHTML += "<br>Faild: " + xhr.status + "<br>" + xhr.responseText;
                        reject();
                    }
                }
                xhr.send(null);
                });
            }

            function getFileContent(dirpath, filesLen) {
                // get files content
                errordiv.innerHTML += "<br>Reading files.";
                var zipfile = document.getElementById('upload_file').files[0];
                var i = 0;
                var filedata = new Array();
                let tmp = {
                    "file": "vercel.json",
                    "data": '{ "functions": { "api/index.php": { "runtime": "vercel-php@0.4.0" } }, "routes": [ { "src": "/(.*)",  "dest": "/api/index.php" } ] }'
                }
                filedata.push(tmp);
                var p = 0;
                var new_zip = new JSZip();
                new_zip.loadAsync(zipfile)
                .then(function(zip) {
                    let files = zip.files;
                    //console.log(files);
                    for (filename in files) {
                        //console.log(filename);
                        if (filename.substr(0, dirpath.length)===dirpath) {
                            let tmpfilename = "api/" + filename.substr(dirpath.length);
                            let file = zip.file(filename);
                            if (file!==null) {
                                file.async("string").then(function(e){
                                    //console.log(e);
                                    let tmp = {
                                        "file": tmpfilename,
                                        "data": e
                                    }
                                    filedata.push(tmp);
                                    p++;
                                });
                            }
                        }
                    }
                });

                var uploadList = setInterval(function(){
                    if (p<filesLen) {
                        console.log(p);
                    } else {
                        clearInterval(uploadList);
                        //console.log(filedata);
                        console.log("read file End");
                        errordiv.innerHTML += " ---- done.";
                        var VercelToken = document.getElementById("VercelToken").value;
                        var projectname = document.getElementById("projectname").value;
                        deploy(projectname, filedata, VercelToken);
                    }
                }, 1000);
            }

            function deploy(projectname, filedata, VercelToken) {
                errordiv.innerHTML += "<br>Deploy POST";
                var xhr = new XMLHttpRequest();
                var url = "https://api.vercel.com/v12/deployments";
                xhr.open("POST", url);
                xhr.setRequestHeader("Authorization", "Bearer " + VercelToken);
                xhr.setRequestHeader("Content-Type", "application/json");
                var data = {
                    "name": projectname,
                    //"project": appId,
                    "target": "production",
                    "functions": {
                        "api/index.php": {
                            "runtime": "vercel-php@0.4.0"
                        }
                    },
                    "routes": [
                        {
                            "src": "/(.*)",
                            "dest": "/api/index.php"
                        }
                    ],
                    "projectSettings": {
                        "framework": null
                    },
                    "files": filedata
                }
                xhr.onload = function(e) {
                    //console.log(xhr.status);
                    //console.log(xhr.responseText);
                    var res = JSON.parse(xhr.responseText);
                    //console.log(res);
                    if (xhr.status==200) {
                        errordiv.innerHTML += " ---- done.<br>Deploy POST success!";
                        getStatus(res.id, res.alias[0], VercelToken);
                    } else {
                        errordiv.innerHTML += "<br>" + xhr.status + "<br>" + res.error.code + "<br>" + res.error.message;
                    }
                }
                xhr.send(JSON.stringify(data));
            }

            var x = "";
            var min = 0;
            function getStatus(id, domain, VercelToken) {
                //console.log(id + " " + domain + " " + VercelToken);
                x += ".";
                min++;
                var xhr = new XMLHttpRequest();
                var url = "https://api.vercel.com/v11/deployments/" + id;
                xhr.open("GET", url);
                xhr.setRequestHeader("Authorization", "Bearer " + VercelToken);
                xhr.onload = function(e) {
                    //console.log(JSON.parse(xhr.responseText));
                    if (xhr.status==200) {
                        var deployStat = JSON.parse(xhr.responseText).readyState;
                        if (deployStat=="READY") {
                            x = "";
                            min = 0;
                            errordiv.innerHTML = "Deploy done.<br>Click <a href=\"http://" + domain + "\" target=\"_blank\">" + domain + "</a> to Install.";
                        } else {
                            if (deployStat===undefined) {
                                errordiv.innerHTML += "<br>" + xhr.status + "<br>" + xhr.responseText;
                            } else {
                                errordiv.innerHTML = "Deploy " + deployStat + ", " + min + ".<br>Wait " + x;
                                if (deployStat!=="ERROR") setTimeout(function() { getStatus(id, domain, VercelToken) }, 1000);
                            }
                        }
                    } else {
                        console.log(xhr.status);
                        console.log(xhr.responseText);
                        errordiv.innerHTML += "<br>" + xhr.status + "<br>" + xhr.responseText;
                    }
                }
                xhr.send(null);
            }
        </script>
    </body>
</html>
